<!DOCTYPE html>
<html>
    <head>
        <title>
            Cities Map
        </title>
        <meta charset="utf-8">
        <style>
            #map.limited {
                max-width: 75%;
                max-height: 75%;
            }
            #customfilediv {
                margin-top: 25px;
            }
            div {
                margin: 15px;
            }
        </style>
    </head>

    <body>
        <div>
            <canvas class="limited" id="map" width="1" height="1"></canvas>
        </div>

        <div>
            <div>
                <input id="adjust" checked type="checkbox" onclick="drawMap()">
                <label for="adjust">
                    Adjust dot size (not to scale!)
                </label>
            </div>

            <div>
                <input id="minpopulation" type="number" value="100000" autocomplete="false" onchange="drawMap()">
                <label for="minpopulation">
                    Minimum population
                </label>
            </div>

            <div>
                <input id="showtext" type="checkbox" onclick="drawMap()">
                <label for="showtext">
                    Show city names (Large cities only)
                </label>
            </div>

            <div style="display: none;">
                <label for="imageselector">
                    Image
                </label>
                <select id="imageselector" onchange="loadImage()">
                    <option value="equirectangular_with_lines.jpg">Normal</option>
                    <option value="equirectangular_nasa.png">Satellite</option>
                </select>
            </div>

            <div>
                <input id="limitimage" checked onchange="changeImageLimit(this);" type="checkbox">
                <label for="limitimage">
                    Limit image size (Turn off for zooming)
                </label>
            </div>

            <div>
                <button>
                    Redraw
                </button>
            </div>
        </div>

        <cite>
            (Normal) Image by Strebe, <a href="https://creativecommons.org/licenses/by-sa/3.0">CC BY-SA 3.0</a>
        </cite>
        <br>
        <cite>
            Dataset by Geonames.org, <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>
        </cite>

        <div id="customfilediv">
            <div>
                <label for="custom">
                    Custom Dataset
                </label>
                <input type="file" id="custom" onchange="loadFile(this.files[0]);">
            </div>
        </div>
    </body>

    <script>
        const indices = {
            geonameid: 0,
            name: 1,
            asciiname: 2,
            alternatenames: 3,
            latitude: 4,
            longitude: 5,
            cc2: 9,
            population: 14,
            elevation: 15,
            dem: 16,
            timezone: 17
        };

        const context = document.getElementById("map").getContext("2d");

        const image = new Image();
        image.onload = () => {
            let map = document.getElementById("map");
            map.width = image.width;
            map.height = image.height;
            if(data) {
                drawMap();
            } else {
                clear();
            }
        }

        function loadImage() {
            image.src = element("imageselector").value;
        }

        let texts;
        let cities;
        let data;

        function updateMap() {
            texts = [];

            data = data.split("\n");
            data = data.map(item => item.split("\t"));
            cities = data;
            drawMap();
        }

        function drawMap() {
            clear();

            cities.forEach(city => {
                    let population = city[indices.population];
                    let populationNumber = parseInt(population);
                    if(populationNumber < parseInt(element("minpopulation").value) || population == undefined) {
                        return;
                    }

                    drawCity(parseInt(city[indices.longitude]), parseInt(city[indices.latitude]), populationNumber, city[indices.name]);
                }
            );

            if(element("showtext").checked) {
                drawTexts();
            }
        }

        function clear() {
            context.clearRect(0, 0, image.width, image.height);
            context.drawImage(image, 0, 0);
        }

        function drawCity(longitude, latitude, population, name) {
            let longitudeValue = image.width / 360;
            let latitudeValue = image.height / 180;

            let size = 0;
            if(element("adjust").checked) {
                let arbitrarySizeScaling = 250 / image.width / image.height;
                size = Math.sqrt(population * arbitrarySizeScaling);
            } else {
                let arbitrarySizeScaling = 10 / image.width / image.height;
                size = population * arbitrarySizeScaling;
            }

            let x = (longitude + 180) * longitudeValue;
            let y = (-latitude + 90) * latitudeValue;

            drawCircle(x, y, size);

            if(element("showtext").checked && population > 3500000) {
                texts.push([name, x, y, size]);
            }
        }

        function drawTexts() {
            texts.forEach(text => {
                drawText(text[0], text[1], text[2], text[3], "white");
            });
        }

        function randInt(lower, upper) {
            return Math.floor(Math.random() * upper) + lower;
        }

        function drawCircle(x, y, size) {
            context.beginPath();
            context.ellipse(x, y, size / 2, size / 2, 0, 0, 2 * Math.PI);
            context.fill();
            context.stroke();
        }
        
        function drawText(text, x, y, size, color) {
            context.font = size + "px serif";
            context.fillStyle = color;
            context.fillText(text, x, y);
            context.fillStyle = "black";
        }

        function element(elem) {
            return document.getElementById(elem);
        }

        function changeImageLimit(input) {
            if(input.checked) {
                element("map").classList.add("limited");
            } else {
                element("map").classList.remove("limited");
            }
        }
    </script>

    <script defer>
        fetch("cities15000.txt").then(res => res.text()).then(res => {data = res; updateMap()}, err => {alert("There was an error loading the data."); console.error(err)});
        
        function loadFile(file) {
            let reader = new FileReader();

            reader.onload = () => {
                data = reader.result;
                updateMap();
            }

            reader.onerror = () => {
                alert("There was an error loading the custom data");
            }

            reader.readAsText(file);
        }

        loadImage();
    </script>
</html>